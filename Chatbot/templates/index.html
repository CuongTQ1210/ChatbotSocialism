<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Lịch Sử Việt Nam</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #b71c1c;
            --secondary-color: #e3f2fd;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
            --error-color: #d32f2f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            max-width: 800px;
            margin: 1rem auto;
            padding: 1rem;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 300px;
            max-height: calc(100vh - 250px);
            scroll-behavior: smooth;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 15px;
            margin: 0.2rem 0;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
            line-height: 1.5;
            white-space: pre-wrap; /* Đảm bảo xuống dòng đúng cách */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: var(--secondary-color);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            color: var(--text-color);
        }

        .bot-message {
            background-color: #e3f2fd;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            color: var(--text-color);
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .highlight-year {
            color: red;
            font-weight: bold;
        }

        .message-source {
            font-size: 0.8em;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .source-local {
            color: #1565c0;
        }

        .source-gpt {
            color: #2e7d32;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: white;
            border-radius: 0 0 15px 15px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(183, 28, 28, 0.1);
        }

        button {
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        button:hover {
            background-color: #d32f2f;
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 0.5rem 1rem;
            color: #666;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--error-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            display: none;
            animation: slideDown 0.3s ease-out;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .suggestion-chip {
            padding: 0.5rem 1rem;
            background-color: var(--light-gray);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .suggestion-chip:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        @media (max-width: 600px) {
            .chat-container {
                margin: 0.5rem;
                height: calc(100vh - 1rem);
            }

            .message {
                max-width: 90%;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .suggestions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Chatbot Lịch Sử Việt Nam</h1>
        <p>Hỏi đáp về lịch sử, nhân vật và các sự kiện quan trọng</p>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="bot-message message">
Xin chào! Tôi là chatbot chuyên về lịch sử Việt Nam. 
Bạn có thể hỏi tôi về các sự kiện, nhân vật và mốc thời gian quan trọng trong lịch sử.
                <div class="message-source source-local">
                    <i class="fas fa-database"></i>
Hệ thống
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <i class="fas fa-circle"></i>
            <i class="fas fa-circle"></i>
            <i class="fas fa-circle"></i>
            Đang trả lời...
        </div>

        <div class="suggestions">
            <div class="suggestion-chip" onclick="useTemplate('Ai là Lý Thường Kiệt?')">Ai là Lý Thường Kiệt?</div>
            <div class="suggestion-chip" onclick="useTemplate('Kể về khởi nghĩa Hai Bà Trưng')">Khởi nghĩa Hai Bà Trưng</div>
            <div class="suggestion-chip" onclick="useTemplate('Chiến thắng Bạch Đằng diễn ra khi nào?')">Chiến thắng Bạch Đằng</div>
            <div class="suggestion-chip" onclick="useTemplate('Nhà Lý cai trị trong thời gian nào?')">Thời Nhà Lý</div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="Nhập câu hỏi của bạn..."
                    onkeypress="handleKeyPress(event)"
                    autocomplete="off"
                >
            </div>
            <button id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
                Gửi
            </button>
        </div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const errorMessage = document.getElementById('errorMessage');

        function addMessage(message, isUser, source = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            // Highlight the years in the response
            message = message.replace(/\b(\d{4})\b/g, '<span class="highlight-year">$1</span>');
            
            const messageContent = document.createElement('div');
            messageContent.innerHTML = message;  // Use innerHTML to render highlighted years
            messageDiv.appendChild(messageContent);
            
            if (!isUser && source) {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = `message-source source-${source}`;
                const icon = document.createElement('i');
                icon.className = source === 'local' ? 'fas fa-database' : 'fas fa-robot';
                sourceDiv.appendChild(icon);
                sourceDiv.appendChild(document.createTextNode(
                    source === 'local' ? 'Hệ thống' : 'GPT-3.5'
                ));
                messageDiv.appendChild(sourceDiv);
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'flex';
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => errorMessage.style.display = 'none', 4000);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            try {
                userInput.value = '';
                addMessage(message, true);
                showTypingIndicator();

                const response = await fetch('http://127.0.0.1:5000/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (!data.response) {
                    showError('Câu trả lời không có sẵn. Vui lòng thử lại sau.');
                    addMessage('Câu trả lời không có sẵn.', false);
                } else {
                    addMessage(data.response, false, data.source);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Có lỗi xảy ra khi kết nối với server. Vui lòng thử lại sau.');
            } finally {
                hideTypingIndicator();
            }
        }

        function useTemplate(template) {
            userInput.value = template;
            sendMessage();
        }
    </script>
</body>
</html>
